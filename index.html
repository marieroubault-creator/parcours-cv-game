<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parcours √† la carte ‚Äì France Travail</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
body{
  margin:0;
  font-family:"Marianne", Arial, sans-serif;
  background:linear-gradient(180deg,#eef3ff,#f7f7f7);
  color:#1d1e3c;

/* Supprime le fond et le contour blanc de la popup Leaflet */
.leaflet-popup-content-wrapper,
.leaflet-popup-tip {
  background: transparent;
  box-shadow: none;
  border: none;
}

/* Ajuste le padding interne */
.leaflet-popup-content {
  margin: 0;
}


/* Header */
.header{
  background:#1d1e3c;
  color:white;
  text-align:center;
  padding:14px 10px;
  border-bottom:6px solid #406bde;
}
.header h1{ margin:0; font-size:26px; }

/* Status bar */
.status-bar{
  display:flex;
  justify-content:center;
  gap:20px;
  flex-wrap:wrap;
  margin:15px 0;
}
.status-item{
  background:white;
  padding:10px 18px;
  border-left:6px solid #1d1e3c;
  border-radius:6px;
}

/* Map */
#map-container{ display:flex; justify-content:center; }
#map{
  height:75vh;
  width:90%;
  max-width:1000px;
  border:4px solid #1d1e3c;
  border-radius:12px;
}

/* Modal */
.modal-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9999;
}
.modal{
  background:white;
  padding:20px;
  border-radius:12px;
  border:3px solid #1d1e3c;
  width:320px;
  text-align:center;
  position:relative;
}
.modal button{
  background:#1d1e3c;
  color:white;
  border:none;
  padding:10px 16px;
  border-radius:6px;
  margin-top:12px;
  cursor:pointer;
}
.close-btn{
  position:absolute;
  top:8px;
  right:12px;
  cursor:pointer;
  font-size:20px;
}

/* Start popup */
.start-popup{
  background:#406bde;
  color:white;
  padding:12px 16px;
  border-radius:10px;
  text-align:center;
  font-weight:600;
  cursor:pointer;
}
.start-popup:hover{ background:#3056c8; }
.start-arrow{ font-size:18px; margin-top:4px; }
</style>
</head>

<body>

<div class="header">
  <h1>Parcours √† la carte ‚Äì Gagne des points en d√©posant des CV</h1>
</div>

<div class="status-bar">
  <div class="status-item">Score : <span id="score">0</span></div>
  <div class="status-item">Temps restant : <span id="timer">2:30:00</span></div>
</div>

<div id="map-container">
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* MAP */
let map = L.map('map').setView([48.648,-2.025],16);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

/* SCORE */
let score=0;
function updateScore(){ document.getElementById("score").textContent=score; }

/* TIMER */
let totalSeconds=2.5*3600;
function updateTimer(){
  let h=Math.floor(totalSeconds/3600);
  let m=Math.floor((totalSeconds%3600)/60);
  let s=Math.floor(totalSeconds%60);
  document.getElementById("timer").textContent=
    `${h}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
  totalSeconds--;
}
setInterval(updateTimer,1000);

/* DATA */
const points={
  start:{name:"La Perle Malouine",coords:[48.6475,-2.026],next:"pt2"},
  pt2:{name:"Grand M√®re Augustine",coords:[48.6482,-2.025],next:"pt3"},
  pt3:{name:"La Table Malouine",coords:[48.6488,-2.0242],next:"pt4"},
  pt4:{name:"Cr√™perie La Duchesse Anne",coords:[48.6493,-2.0235],next:null}
};

const enigmes={
  start:{q:"Qui est le corsaire embl√©matique de Saint-Malo ?",a:"surcouf"},
  pt2:{q:"Comment s'appelle le palais de Saint-Malo ?",a:"le palais du grand large"},
  pt3:{q:"Quelle est la devise de Saint-Malo ?",a:"semper fidelis"},
  pt4:{q:"√éle fortifi√©e accessible √† mar√©e basse ?",a:"ile du grand b√©"}
};

let path=[],polyline;

/* ICON START */
let startIcon=L.icon({
  iconUrl:"https://cdn-icons-png.flaticon.com/512/535/535239.png",
  iconSize:[40,40],iconAnchor:[20,40]
});

/* START MARKER + CLICKABLE BUBBLE */
let startMarker=L.marker(points.start.coords,{icon:startIcon})
.addTo(map)
.bindPopup(`
  <div class="start-popup" onclick="startParcours()">
    Cliquez ici pour commencer
    <div class="start-arrow">‚¨á</div>
  </div>
`)
.openPopup();

/* START */
function startParcours(){
  map.closePopup();
  showEnigme("start");
}

/* PATH */
function updatePath(){
  if(polyline) map.removeLayer(polyline);
  polyline=L.polyline(path,{color:"#1d1e3c",weight:4}).addTo(map);
}

/* ENIGME */
function showEnigme(key){
  const modal=document.createElement("div");
  modal.className="modal-bg";
  modal.innerHTML=`
    <div class="modal">
      <span class="close-btn" onclick="closeModal()">√ó</span>
      <h3>${points[key].name}</h3>
      <p>${enigmes[key].q}</p>
      <input id="answer" style="width:90%;padding:6px"/>
      <button onclick="checkAnswer('${key}')">Valider</button>
    </div>`;
  document.body.appendChild(modal);
}

function checkAnswer(key){
  let val=document.getElementById("answer").value.trim().toLowerCase();
  if(val!==enigmes[key].a) return alert("Mauvaise r√©ponse !");
  score+=2; updateScore(); closeModal();
  path.push(points[key].coords); updatePath();
  let next=points[key].next;
  if(next) revealPoint(next); else showCongrats();
}

function revealPoint(key){
  let m=L.circleMarker(points[key].coords,{
    radius:10,color:"#1d1e3c",fillColor:"#1d1e3c",fillOpacity:1
  }).addTo(map);
  m.bindPopup(`<b>${points[key].name}</b>`).openPopup();
}

function closeModal(){
  document.querySelectorAll(".modal-bg").forEach(m=>m.remove());
}

/* FINAL */
function showCongrats(){
  const modal=document.createElement("div");
  modal.className="modal-bg";
  modal.innerHTML=`
    <div class="modal">
      <span class="close-btn" onclick="closeModal()">√ó</span>
      <h2>üéâ Bravo !</h2>
      <p>Vous avez termin√© le parcours.</p>
      <button onclick="location.reload()">Rejouer</button>
    </div>`;
  document.body.appendChild(modal);
}
</script>

</body>
</html>
