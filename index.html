<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Parcours Ã  la carte - Gagne des points en dÃ©posant des CV</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body { font-family:"Marianne", Arial; margin:0; background:white; color:#1d1e3c; text-align:center; }
  h1{ margin-top:20px; font-size:28px; }
  .status-bar{ display:flex; justify-content:center; gap:20px; margin:10px 0; flex-wrap: wrap; }
  .status-item{ background:#DBE3FF; padding:10px 16px; border-radius:8px; border:2px solid #1d1e3c; }
  #map-container{ display:flex; justify-content:center; margin-top:10px; }
  #map{
    height:75vh;
    width:90%;
    max-width:1000px;
    border:4px solid #1d1e3c;
    border-radius:12px;
    margin:0 auto;
  }
  .modal-bg{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.55); display:flex; justify-content:center; align-items:center; z-index:9999; }
  .modal{ background:#DBE3FF; padding:20px; border-radius:12px; border:3px solid #1d1e3c; width:300px; position:relative; }
  .modal button{ background:#1d1e3c; color:white; border:none; padding:8px 14px; margin-top:12px; border-radius:6px; cursor:pointer; }
  .close-btn{ position:absolute; top:5px; right:8px; cursor:pointer; font-weight:bold; font-size:18px; }
  .leaflet-popup-content-wrapper {
    background: #DBE3FF;
    color: #1d1e3c;
    font-weight: bold;
    border: 2px solid #1d1e3c;
    border-radius: 8px;
  }
</style>
</head>
<body>

<h1>Parcours Ã  la carte - Gagne des points en dÃ©posant des CV</h1>
<div class="status-bar">
  <div class="status-item">Score : <span id="score">0</span></div>
  <div class="status-item">Temps restant : <span id="timer">2:30:00</span></div>
</div>

<div id="map-container"><div id="map"></div></div>

<script>
let map = L.map('map').setView([48.648, -2.025], 16);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

let score = 0;
function updateScore(){ document.getElementById('score').textContent = score; }

// Timer 2h30
let totalSeconds = 2.5 * 3600;
function updateTimer(){
  let h = Math.floor(totalSeconds/3600);
  let m = Math.floor((totalSeconds%3600)/60);
  let s = Math.floor(totalSeconds%60);
  document.getElementById('timer').textContent = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  if(totalSeconds <= 0){
    alert("Perdu, rdv au point de dÃ©part");
    location.reload();
  }
  totalSeconds--;
}
updateTimer();
setInterval(updateTimer, 1000);

// ---------------------------------------------------------
// POINTS DU PARCOURS
// ---------------------------------------------------------
const points = {
  start:{ name:"La Perle Malouine", coords:[48.6475,-2.026], next:"pt2", address:"Adresse point de dÃ©part" },
  pt2:{ name:"Grand MÃ¨re Augustine", coords:[48.6482,-2.025], next:"pt3", address:"Adresse pt2" },
  pt3:{ name:"La Table Malouine", coords:[48.6488,-2.0242], next:"pt4", address:"Adresse pt3" },
  pt4:{ name:"CrÃªperie La Duchesse Anne", coords:[48.6493,-2.0235], next:null, address:"Adresse pt4" }
};

const enigmes = {
  start:{ q:"Qui est le corsaire emblÃ©matique de Saint-Malo ?", a:"surcouf", site:"https://restaurant1.com", offres:"https://francetravail.fr" },
  pt2:{ q:"Comment s'appelle le palais de Saint-Malo ?", a:"le palais du grand large", site:"https://restaurant2.com", offres:"https://francetravail.fr"},
  pt3:{ q:"Quelle est la devise de Saint-Malo ?", a:"semper fidelis", site:"https://restaurant3.com", offres:"https://francetravail.fr"},
  pt4:{ q:"ÃŽle fortifiÃ©e accessible Ã  marÃ©e basse ?", a:"ile du grand bÃ©", site:"https://restaurant4.com", offres:"https://francetravail.fr"}
};

let markers = {};
let previousPoint = null;

// ---------------------------------------------------------
// AFFICHAGE DU PREMIER POINT (Ã‰PINGLE ROUGE)
// ---------------------------------------------------------
let redIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/535/535239.png",
  iconSize: [40, 40],
  iconAnchor: [20, 40]
});

markers["start"] = L.marker(points["start"].coords, { icon: redIcon })
  .addTo(map)
  .bindPopup("<b>Point de dÃ©part :</b><br>La Perle Malouine");

markers["start"].on("click", () => showEnigme("start"));

// ---------------------------------------------------------
// MODALE Ã‰NIGME
// ---------------------------------------------------------
function showEnigme(key){
  if(document.querySelector('.modal-bg')) return;
  const modal = document.createElement('div');
  modal.className = 'modal-bg';
  modal.innerHTML = `
    <div class="modal">
      <span class="close-btn" onclick="closeModal()">Ã—</span>
      <h3>${points[key].name}</h3>
      <p><b>Adresse :</b> ${points[key].address}</p>
      <p>${enigmes[key].q}</p>
      <input id="answerInput" style="padding:6px; width:90%; margin-top:10px" />
      <button onclick="checkAnswer('${key}')">Valider</button>
    </div>`;
  document.body.appendChild(modal);
}

function closeModal(){
  document.querySelectorAll('.modal-bg').forEach(m => m.remove());
}

// ---------------------------------------------------------
// VALIDATION Ã‰NIGME
// ---------------------------------------------------------
function checkAnswer(key){
  let val = document.getElementById('answerInput').value.trim().toLowerCase();
  if(val === enigmes[key].a.toLowerCase()){
    score += 2; updateScore();
    closeModal();

    let next = points[key].next;
    if(next){
      drawDotsAnimated(key, next);
      revealPoint(next);
    } else {
      // Fin du parcours
      drawDotsAnimated(key, "start"); // animation retour au dÃ©part
      showEndModal();
    }
  } else {
    alert("Mauvaise rÃ©ponse");
  }
}

// ---------------------------------------------------------
// ANIMATION POINTILLÃ‰E ENTRE 2 POINTS
// ---------------------------------------------------------
function drawDotsAnimated(fromKey, toKey){
  let from = points[fromKey].coords;
  let to = (toKey === "start") ? points["start"].coords : points[toKey].coords;

  let latStep = (to[0]-from[0]) / 20;
  let lngStep = (to[1]-from[1]) / 20;
  let i = 1;

  function anim(){
    if(i > 20) return;

    L.circleMarker([from[0] + latStep*i, from[1] + lngStep*i], {
      radius:4, color:"#1d1e3c", fillColor:"#1d1e3c", fillOpacity:1
    }).addTo(map);

    i++;
    setTimeout(anim, 100);
  }
  anim();
}

// ---------------------------------------------------------
// AFFICHAGE DU POINT SUIVANT + POPUP NOM
// ---------------------------------------------------------
function revealPoint(key){
  markers[key] = L.circleMarker(points[key].coords, {
    radius:12, color:"#1d1e3c", fillColor:"#1d1e3c", fillOpacity:1
  }).addTo(map);

  markers[key].bindPopup(`
    <b><a href="#" onclick="showFullPopup('${key}')">${points[key].name}</a></b>
  `).openPopup();

  previousPoint = key;
}

// ---------------------------------------------------------
// POPUP COMPLÃˆTE : Ã‰NIGME + SITE + OFFRES + VALIDATION
// ---------------------------------------------------------
function showFullPopup(key){
  const p = points[key];
  const e = enigmes[key];

  const modal = document.createElement("div");
  modal.className = "modal-bg";
  modal.innerHTML = `
    <div class="modal">
      <span class="close-btn" onclick="closeModal()">Ã—</span>
      <h2>${p.name}</h2>
      <p><b>Adresse :</b> ${p.address}</p>
      <p><b>Site web :</b><br>
         <a href="${e.site}" target="_blank">${e.site}</a></p>
      <p><b>Offres France Travail :</b><br>
         <a href="${e.offres}" target="_blank">${e.offres}</a></p>
      <hr>
      <p><b>Ã‰nigme :</b><br>${e.q}</p>
      <input id="answer2" style="padding:6px; width:90%;"/>
      <button onclick="validateNext('${key}')">Valider</button>
    </div>
  `;
  document.body.appendChild(modal);
}

function validateNext(key){
  let val = document.getElementById("answer2").value.trim().toLowerCase();
  if(val !== enigmes[key].a.toLowerCase()) return alert("Mauvaise rÃ©ponse !");
  closeModal();

  let next = points[key].next;
  if(next){
    drawDotsAnimated(key, next);
    revealPoint(next);
  } else {
    drawDotsAnimated(key, "start"); // animation retour au dÃ©part
    showEndModal();
  }
}

// ---------------------------------------------------------
// FENETRE DE FIN DE PARCOURS
// ---------------------------------------------------------
function showEndModal(){
  closeModal(); // ferme toutes les modales
  const modal = document.createElement("div");
  modal.className = "modal-bg";
  modal.innerHTML = `
    <div class="modal">
      <span class="close-btn" onclick="closeModal()">Ã—</span>
      <h2>ðŸŽ‰ Bravo ! ðŸŽ‰</h2>
      <p>Vous avez terminÃ© ce parcours !</p>
      <p>Rendez-vous au point de dÃ©part, on vous attend !</p>
    </div>`;
  document.body.appendChild(modal);
}
</script>
</body>
</html>
