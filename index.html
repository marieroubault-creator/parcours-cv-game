<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parcours √† la carte - Gagne des points en d√©posant des CV</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  body { font-family:"Marianne", Arial; margin:0; background:white; color:#1d1e3c; text-align:center; }
  h1{ margin-top:20px; font-size:28px; }
  .status-bar{ display:flex; justify-content:center; gap:20px; margin:10px 0; flex-wrap: wrap; }
  .status-item{ background:#DBE3FF; padding:10px 16px; border-radius:8px; border:2px solid #1d1e3c; }
  #map-container{ display:flex; justify-content:center; margin-top:10px; }
  #map{
    height:75vh;
    width:90%;
    max-width:1000px;
    border:4px solid #1d1e3c;
    border-radius:12px;
    margin:0 auto;
  }
  .modal-bg{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.55); display:flex; justify-content:center; align-items:center; z-index:9999; }
  .modal{ background:#DBE3FF; padding:20px; border-radius:12px; border:3px solid #1d1e3c; width:300px; position:relative; }
  .modal button{ background:#1d1e3c; color:white; border:none; padding:8px 14px; margin-top:12px; border-radius:6px; cursor:pointer; }
  .close-btn{ position:absolute; top:8px; right:12px; font-size:18px; font-weight:bold; cursor:pointer; }
  .leaflet-popup-content-wrapper {
    background: #DBE3FF;
    color: #1d1e3c;
    font-weight: bold;
    border: 2px solid #1d1e3c;
    border-radius: 8px;
  }
  .highlight { color: red; font-weight:bold; }
</style>
</head>
<body>

<h1>Parcours √† la carte - Gagne des points en d√©posant des CV</h1>
<div class="status-bar">
  <div class="status-item">Score : <span id="score">0</span></div>
  <div class="status-item">Temps restant : <span id="timer">2:30:00</span></div>
</div>

<div id="map-container"><div id="map"></div></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([48.648, -2.025], 16);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

let score = 0;
function updateScore(){ document.getElementById('score').textContent = score; }

// Timer 2h30
let totalSeconds = 2.5 * 3600;
function updateTimer(){
  let h = Math.floor(totalSeconds/3600);
  let m = Math.floor((totalSeconds%3600)/60);
  let s = Math.floor(totalSeconds%60);
  document.getElementById('timer').textContent = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
  if(totalSeconds <= 0){
    alert("Perdu, rdv au point de d√©part");
    location.reload();
  }
  totalSeconds--;
}
updateTimer();
setInterval(updateTimer, 1000);

// Points du parcours
const points = {
  start:{ name:"La Perle Malouine", address:"1 rue de la Perle, Saint-Malo", coords:[48.6475,-2.026], next:"pt2" },
  pt2:{ name:"Grand M√®re Augustine", address:"10 rue des Corsaires, Saint-Malo", coords:[48.6482,-2.025], next:"pt3" },
  pt3:{ name:"La Table Malouine", address:"5 quai Duguay-Trouin, Saint-Malo", coords:[48.6488,-2.0242], next:"pt4" },
  pt4:{ name:"Cr√™perie La Duchesse Anne", address:"2 rue de l'Orme, Saint-Malo", coords:[48.6493,-2.0235], next:null }
};

const enigmes = {
  start:{ q:"Qui est le corsaire embl√©matique de Saint-Malo ?", a:"surcouf", site:"https://restaurant1.com", offres:"https://francetravail.fr" },
  pt2:{ q:"Comment s'appelle le palais de Saint-Malo ?", a:"le palais du grand large", site:"https://restaurant2.com", offres:"https://francetravail.fr"},
  pt3:{ q:"Quelle est la devise de Saint-Malo ?", a:"semper fidelis", site:"https://restaurant3.com", offres:"https://francetravail.fr"},
  pt4:{ q:"√éle fortifi√©e accessible √† mar√©e basse ?", a:"ile du grand b√©", site:"https://restaurant4.com", offres:"https://francetravail.fr"}
};

let markers = {};
let visitedPaths = [];

// √âpingle rouge pour point de d√©part
let startIcon = L.icon({ iconUrl: "https://cdn-icons-png.flaticon.com/512/535/535239.png", iconSize:[40,40], iconAnchor:[20,40] });
markers["start"] = L.marker(points["start"].coords, { icon: startIcon }).addTo(map)
  .bindPopup(`<b>Point de d√©part :</b><br>${points["start"].name}<br>${points["start"].address}`);
markers["start"].on("click", () => showEnigme("start"));

// MODALE
function showEnigme(key){
  if(document.querySelector('.modal-bg')) return;
  const modal=document.createElement('div');
  modal.className='modal-bg';
  modal.innerHTML=`
    <div class="modal">
      <span class="close-btn" onclick="closeModal()">√ó</span>
      <h3>${points[key].name}</h3>
      <p><b>Adresse :</b> ${points[key].address}</p>
      <p>${enigmes[key].q}</p>
      <input id="answerInput" style="padding:6px; width:90%; margin-top:10px" />
      <button onclick="checkAnswer('${key}')">Valider</button>
    </div>
  `;
  document.body.appendChild(modal);
}

function checkAnswer(key){
  let val = document.getElementById('answerInput').value.trim().toLowerCase();
  if(val === enigmes[key].a.toLowerCase()){
    score+=2; updateScore();
    closeModal();
    let next = points[key].next;
    if(next){ drawDotsAnimated(key,next); revealPoint(next); }
    else showCongrats();
  } else alert("Mauvaise r√©ponse");
}

// Animation pointill√©
function drawDotsAnimated(fromKey,toKey){
  let from=points[fromKey].coords, to=points[toKey].coords;
  let latStep=(to[0]-from[0])/20, lngStep=(to[1]-from[1])/20, i=1;
  function anim(){
    if(i>20) return;
    let dot = L.circleMarker([from[0]+latStep*i, from[1]+lngStep*i], {radius:4, color:"#1d1e3c", fillColor:"#1d1e3c", fillOpacity:1}).addTo(map);
    visitedPaths.push(dot);
    i++; setTimeout(anim,100);
  }
  anim();
}

// Affichage point suivant
function revealPoint(key){
  markers[key]=L.circleMarker(points[key].coords,{radius:12,color:"#1d1e3c",fillColor:"#1d1e3c",fillOpacity:1}).addTo(map);
  markers[key].bindPopup(`<b><a href="#" onclick="showFullPopup('${key}')">${points[key].name}</a></b>`).openPopup();
}

// Pop-up compl√®te
function showFullPopup(key){
  closeModal();
  const p=points[key], e=enigmes[key];
  const modal=document.createElement("div");
  modal.className="modal-bg";
  modal.innerHTML=`
    <div class="modal">
      <span class="close-btn" onclick="closeModal()">√ó</span>
      <h2>${p.name}</h2>
      <p><b>Adresse :</b> ${p.address}</p>
      <p><b>Site web :</b><br><a href="${e.site}" target="_blank">${e.site}</a></p>
      <p><b>Offres France Travail :</b><br><a href="${e.offres}" target="_blank">${e.offres}</a></p>
      <hr>
      <p><b>√ânigme :</b><br>${e.q}</p>
      <input id="answer2" style="padding:6px; width:90%;"/>
      <button onclick="validateNext('${key}')">Valider</button>
    </div>
  `;
  document.body.appendChild(modal);
}

function validateNext(key){
  let val=document.getElementById("answer2").value.trim().toLowerCase();
  if(val!==enigmes[key].a.toLowerCase()) return alert("Mauvaise r√©ponse !");
  closeModal();
  let next=points[key].next;
  if(next){ drawDotsAnimated(key,next); revealPoint(next); }
  else showCongrats();
}

function closeModal(){ document.querySelectorAll('.modal-bg').forEach(m=>m.remove()); }

// Pop-up finale
function showCongrats(){
  closeModal();
  const modal=document.createElement("div");
  modal.className="modal-bg";
  modal.innerHTML=`
    <div class="modal">
      <span class="close-btn" onclick="closeModal()">√ó</span>
      <h2>üéâ Bravo !</h2>
      <p>Vous avez termin√© ce parcours !</p>
      <a href="#" onclick="highlightReturn()">Retour au point de d√©part</a><br><br>
      <button onclick="location.reload()">Rejouer le parcours</button>
    </div>
  `;
  document.body.appendChild(modal);
}

// Highlight chemin retour
function highlightReturn(){
  if(visitedPaths.length>0) visitedPaths.forEach(dot=>dot.setStyle({color:"red",fillColor:"red"}));
  map.setView(points.start.coords,16);
}
</script>
</body>
</html>
