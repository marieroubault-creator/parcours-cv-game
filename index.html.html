<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Parcours à la carte - Gagne des points en déposant des CV</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
 body { font-family:"Marianne", Arial; margin:0; background:white; color:#1d1e3c; text-align:center; }
 h1{ margin-top:20px; font-size:28px; }
 .status-bar{ display:flex; justify-content:center; gap:20px; margin:10px 0; }
 .status-item{ background:#DBE3FF; padding:10px 16px; border-radius:8px; border:2px solid #1d1e3c; }
 #map-container{ display:flex; justify-content:center; margin-top:10px; }
 #map{ height:75vh; width:70vw; border:4px solid #1d1e3c; border-radius:12px; }
 .modal-bg{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.55); display:flex; justify-content:center; align-items:center; z-index:9999; }
 .modal{ background:#DBE3FF; padding:20px; border-radius:12px; border:3px solid #1d1e3c; width:300px; }
 .modal button{ background:#1d1e3c; color:white; border:none; padding:8px 14px; margin-top:12px; border-radius:6px; cursor:pointer; }
</style>
</head>
<body>

<h1>Parcours à la carte - Gagne des points en déposant des CV</h1>
<div class="status-bar">
 <div class="status-item">Score : <span id="score">0</span></div>
 <div class="status-item">Temps restant : <span id="timer">2:30:00</span></div>
</div>

<div id="map-container"><div id="map"></div></div>

<script>
let map = L.map('map').setView([48.648, -2.025], 16);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

let score = 0;
let unlocked = {};

// ---------------- TIMER 2h30 -------------------
let totalSeconds = 2.5 * 3600;

function updateTimer(){
  let h = Math.floor(totalSeconds/3600);
  let m = Math.floor((totalSeconds%3600)/60);
  let s = Math.floor(totalSeconds%60);
  document.getElementById('timer').textContent = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;

  if(totalSeconds <= 0){
    alert("Perdu, rdv au point de départ");
    location.reload();
  }
  totalSeconds--;
}

updateTimer(); // affichage initial
setInterval(updateTimer, 1000);
// ------------------------------------------------

function updateScore(){ document.getElementById('score').textContent = score; }

function showModal(pointKey, title, question, answer, link, offres) {
  if(document.querySelector('.modal-bg')) return; // éviter plusieurs modals ouvertes
  const modal = document.createElement('div');
  modal.className = 'modal-bg';
  modal.innerHTML = `
  <div class="modal">
    <h3>${title}</h3>
    <p>${question}</p>
    <input id="answerInput" style="padding:6px; width:90%; margin-top:10px" />
    <p><a href="${link}" target="_blank">Site web</a></p>
    <p><a href="${offres}" target="_blank">Offres France Travail</a></p>
    <button onclick="checkAnswer('${pointKey}','${answer}')">Valider</button>
  </div>`;
  document.body.appendChild(modal);
}

function checkAnswer(pointKey, answer){
  let val = document.getElementById('answerInput').value.trim().toLowerCase();
  if(val === answer.toLowerCase()){
    score += 2;
    updateScore();
    unlocked[pointKey] = true;
    document.querySelectorAll('.modal-bg').forEach(m => m.remove());
    revealNext(pointKey);
    drawDotsAnimated(pointKey);
  } else {
    alert("Mauvaise réponse, recommencez");
  }
}

const points = {
 start:{ name:"La Perle Malouine", coords:[48.6475,-2.026], next:"pt2" },
 pt2:{ name:"Grand Mère Augustine", coords:[48.6482,-2.025], next:"pt3" },
 pt3:{ name:"La Table Malouine", coords:[48.6488,-2.0242], next:"pt4" },
 pt4:{ name:"Crêperie La Duchesse Anne", coords:[48.6493,-2.0235], next:null }
};

const enigmes = {
 start:{ q:"Qui est le corsaire emblématique de Saint-Malo ?", a:"surcouf", link:"https://restaurant1.com", offres:"https://francetravail.fr" },
 pt2:{ q:"Comment s'appelle le palais de Saint-Malo ?", a:"le palais du grand large", link:"https://restaurant2.com", offres:"https://francetravail.fr"},
 pt3:{ q:"Quelle est la devise de Saint-Malo ?", a:"semper fidelis", link:"https://restaurant3.com", offres:"https://francetravail.fr"},
 pt4:{ q:"Île fortifiée accessible à marée basse ?", a:"ile du grand bé", link:"https://restaurant4.com", offres:"https://francetravail.fr"}
};

let markers = {};

function addMarker(key, color){
  let marker = L.circleMarker(points[key].coords, {
    radius:10, color:color, fillColor:color, fillOpacity:0.9
  }).addTo(map);
  markers[key] = marker;
  marker.on('click', ()=>{ showModal(key, points[key].name, enigmes[key].q, enigmes[key].a, enigmes[key].link, enigmes[key].offres); });
}

function revealNext(key){
  let next = points[key].next;
  if(next){ addMarker(next, '#1d1e3c'); }
}

// ---------------- Petits points animés ----------------
function drawDotsAnimated(fromKey){
  let from = points[fromKey].coords;
  let toKey = points[fromKey].next;
  if(!toKey) return; // pas de point suivant
  let to = points[toKey].coords;

  let latStep = (to[0]-from[0]) / 12;
  let lngStep = (to[1]-from[1]) / 12;
  let stepIndex = 1;

  function addDot(){
    if(stepIndex > 12) return;

    L.circleMarker([from[0] + latStep * stepIndex, from[1] + lngStep * stepIndex], {
      radius: 5,
      color: '#1d1e3c',
      fillColor: '#1d1e3c',
      fillOpacity: 0.9
    }).addTo(map);

    stepIndex++;
    setTimeout(addDot, 200);
  }
  addDot();
}

// ---------------- INIT ----------------
addMarker('start','red');
</script>
</body>
</html>
